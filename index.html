<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigma Universal - Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; background-color: #ffffff; color: #0f172a; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        #ui-layer { position: relative; z-index: 10; width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .pro-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(0, 0, 0, 0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01); border-radius: 24px; pointer-events: auto; transition: transform 0.3s ease; }
        .pro-input { background: #ffffff; border: 1px solid #e2e8f0; color: #0f172a; transition: all 0.2s ease; border-radius: 12px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .pro-input:focus { background: #ffffff; outline: none; border-color: #000000; box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05); }
        .btn-pro { background: #000000; color: #ffffff; border: 1px solid #000000; transition: all 0.2s ease; font-weight: 600; border-radius: 12px; }
        .btn-pro:hover { background: #222222; transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loader { width: 20px; height: 20px; border: 2px solid #e2e8f0; border-bottom-color: #000000; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .confetti { position: fixed; width: 8px; height: 8px; background: black; top: -10px; z-index: 50; animation: fall 1.5s linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body class="selection:bg-black selection:text-white">

    <div id="canvas-container"></div>

    <div id="ui-layer" class="px-4">
        <div class="pro-card w-full max-w-md p-8 flex flex-col items-center text-center relative overflow-hidden">
            <div class="mb-6 z-10 w-full flex flex-col items-center">
                <!-- Header Icons -->
                <div class="flex gap-2 mb-4">
                    <div class="w-12 h-12 bg-black rounded-xl flex items-center justify-center shadow-lg shadow-gray-200">
                        <i data-lucide="instagram" class="w-6 h-6 text-white"></i>
                    </div>
                    <div class="w-12 h-12 bg-red-600 rounded-xl flex items-center justify-center shadow-lg shadow-red-200">
                        <i data-lucide="youtube" class="w-6 h-6 text-white"></i>
                    </div>
                </div>
                
                <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">ReelzVault</h1>
                <p class="text-slate-500 mt-2 text-sm font-medium">Reels, YouTube, Shorts & TikTok.</p>
            </div>

            <div class="w-full space-y-4 z-10">
                <!-- Toggle Switch -->
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button id="btnVideo" onclick="setMode('video')" class="flex-1 py-2 rounded-lg text-sm font-semibold shadow-sm bg-white text-black transition-all">Video</button>
                    <button id="btnAudio" onclick="setMode('audio')" class="flex-1 py-2 rounded-lg text-sm font-semibold text-slate-500 hover:text-black transition-all">Audio Only</button>
                </div>

                <div class="relative group text-left">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i data-lucide="link" class="w-5 h-5 text-slate-400"></i></div>
                    <input type="text" id="urlInput" placeholder="Paste YouTube or Insta link..." class="pro-input w-full py-3.5 pl-11 pr-4 text-sm font-medium" autocomplete="off">
                </div>
                <button onclick="processDownload()" id="downloadBtn" class="btn-pro w-full py-3.5 flex items-center justify-center gap-2 group">
                    <span id="btnText">Download Video</span> <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-0.5 transition-transform"></i>
                </button>
            </div>

            <div id="loadingState" class="hidden mt-6 z-10 flex items-center justify-center gap-3">
                <span class="loader"></span> <p class="text-sm font-semibold text-slate-600">Connecting to server...</p>
            </div>

            <div id="resultState" class="hidden w-full mt-8 pt-6 border-t border-slate-100 z-10 fade-in text-left">
                <div class="group bg-green-50 border border-green-100 p-4 rounded-2xl flex gap-4 items-center mb-2">
                     <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0"><i data-lucide="check" class="w-5 h-5 text-green-600"></i></div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-sm text-green-900">Download Started</h3>
                        <p class="text-xs text-green-700">Your media is being saved.</p>
                    </div>
                </div>
                <div class="mt-4 text-center"><button onclick="resetUI()" class="text-xs font-semibold text-slate-400 hover:text-slate-700 transition-colors">Paste another link</button></div>
            </div>

             <div id="errorState" class="hidden mt-4 p-3 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm z-10 fade-in flex items-center justify-center gap-2 font-medium">
                <i data-lucide="alert-circle" class="w-4 h-4"></i> <span id="errorText">Please enter a valid URL</span>
            </div>
            <div class="mt-8 text-[11px] font-medium text-slate-300 z-10"><p>Enigma Labs â€¢ Educational Use Only</p></div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0xffffff, 0.002);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(window.devicePixelRatio); renderer.setClearColor(0xffffff, 0); 
        container.appendChild(renderer.domElement);
        const geometry = new THREE.BufferGeometry(); const count = 1200; const positions = new Float32Array(count * 3); const sizes = new Float32Array(count);
        for(let i = 0; i < count * 3; i+=3) { positions[i] = (Math.random() - 0.5) * 30; positions[i+1] = (Math.random() - 0.5) * 30; positions[i+2] = (Math.random() - 0.5) * 20; sizes[i/3] = Math.random(); }
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
        const particlesMesh = new THREE.Points(geometry, new THREE.PointsMaterial({ size: 0.05, color: 0x000000, transparent: true, opacity: 0.6, sizeAttenuation: true }));
        scene.add(particlesMesh);
        const shapesGroup = new THREE.Group();
        const geomTypes = [new THREE.IcosahedronGeometry(1, 0), new THREE.BoxGeometry(1, 1, 1), new THREE.OctahedronGeometry(1, 0)];
        const shapeMaterial = new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.15, linewidth: 1 });
        for (let i = 0; i < 6; i++) {
            const line = new THREE.LineSegments(new THREE.EdgesGeometry(geomTypes[Math.floor(Math.random() * geomTypes.length)]), shapeMaterial);
            line.position.set((Math.random() - 0.5) * 20, (Math.random() - 0.5) * 20, (Math.random() - 0.5) * 15);
            line.scale.setScalar(Math.random() * 1.5 + 0.5); line.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, 0); shapesGroup.add(line);
        }
        scene.add(shapesGroup);
        camera.position.z = 6;
        let mouseX = 0, mouseY = 0, targetX = 0, targetY = 0; const windowHalfX = window.innerWidth / 2; const windowHalfY = window.innerHeight / 2;
        document.addEventListener('mousemove', (event) => { mouseX = (event.clientX - windowHalfX); mouseY = (event.clientY - windowHalfY); });
        function animate() {
            requestAnimationFrame(animate); targetX = mouseX * 0.0005; targetY = mouseY * 0.0005;
            particlesMesh.rotation.y += 0.0005; particlesMesh.rotation.x += 0.0002;
            particlesMesh.rotation.y += 0.05 * (targetX - particlesMesh.rotation.y); particlesMesh.rotation.x += 0.05 * (targetY - particlesMesh.rotation.x);
            shapesGroup.children.forEach((mesh, i) => { mesh.rotation.x += 0.001 * (i%2===0?1:-1); mesh.rotation.y += 0.002 * (i%2===0?1:-1); });
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        // --- UI LOGIC ---
        let currentMode = 'video';
        const urlInput = document.getElementById('urlInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const btnText = document.getElementById('btnText');
        const loadingState = document.getElementById('loadingState');
        const resultState = document.getElementById('resultState');
        const errorState = document.getElementById('errorState');
        const errorText = document.getElementById('errorText');

        function setMode(mode) {
            currentMode = mode;
            const btnVideo = document.getElementById('btnVideo');
            const btnAudio = document.getElementById('btnAudio');

            if (mode === 'video') {
                btnVideo.className = "flex-1 py-2 rounded-lg text-sm font-semibold shadow-sm bg-white text-black transition-all";
                btnAudio.className = "flex-1 py-2 rounded-lg text-sm font-semibold text-slate-500 hover:text-black transition-all";
                btnText.innerText = "Download Video";
            } else {
                btnVideo.className = "flex-1 py-2 rounded-lg text-sm font-semibold text-slate-500 hover:text-black transition-all";
                btnAudio.className = "flex-1 py-2 rounded-lg text-sm font-semibold shadow-sm bg-white text-black transition-all";
                btnText.innerText = "Download Audio";
            }
        }

        function launchConfetti() { for (let i = 0; i < 40; i++) { const c = document.createElement("div"); c.className = "confetti"; c.style.left = Math.random() * 100 + "vw"; c.style.background = Math.random() > 0.5 ? "#000" : "#333"; c.style.animationDuration = 0.8 + Math.random() * 0.6 + "s"; document.body.appendChild(c); setTimeout(() => c.remove(), 1500); } }

        async function processDownload() {
            const url = urlInput.value.trim();
            errorState.classList.add('hidden'); resultState.classList.add('hidden'); downloadBtn.disabled = false;
            if (!url) { showError("Please paste a URL"); shakeInput(); return; }
            downloadBtn.classList.add('hidden'); loadingState.classList.remove('hidden'); loadingState.classList.add('flex'); urlInput.value = "";

            try {
                // FIXED: URL CONSTRUCTION LOGIC
                // 1. Get the Current Path (e.g. "/reels" or "/")
                const currentPath = window.location.pathname.replace(/\/$/, ''); 
                
                // 2. Detect Local Development (Port 5500 vs 5001)
                const isLocalFrontend = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') && window.location.port !== '5001';
                
                // 3. Build API URL
                const apiUrl = isLocalFrontend 
                    ? 'http://127.0.0.1:5001/download' 
                    : `${window.location.origin}${currentPath}/download`;

                const res = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url: url, type: currentMode }) 
                });

                if (res.status === 405) throw new Error("405 Error: Backend config issue or Port Blocked.");

                let data;
                try { const text = await res.text(); data = text ? JSON.parse(text) : {}; } 
                catch (e) { throw new Error(`Server Error: ${res.status} (Invalid Response)`); }
                
                if (!res.ok) throw new Error(data.error || `Server Error: ${res.status}`);
                if (!data.download_url) throw new Error("Invalid response");

                let finalLink = data.download_url;
                if(finalLink.startsWith('/')) finalLink = finalLink.substring(1);
                
                const downloadLink = isLocalFrontend 
                    ? `http://127.0.0.1:5001/${finalLink}` 
                    : `${window.location.origin}${currentPath}/${finalLink}`;
                
                const a = document.createElement("a"); a.href = downloadLink; a.download = ""; document.body.appendChild(a); a.click(); a.remove();

                launchConfetti(); loadingState.classList.add('hidden'); loadingState.classList.remove('flex'); resultState.classList.remove('hidden');

            } catch (err) {
                console.error(err); loadingState.classList.add('hidden'); loadingState.classList.remove('flex'); downloadBtn.classList.remove('hidden');
                showError(err.message || "Download failed. Check server.");
            }
        }
        function showError(msg) { errorText.innerText = msg; errorState.classList.remove('hidden'); }
        function shakeInput() { urlInput.classList.add('border-red-500', 'bg-red-50'); setTimeout(() => { urlInput.classList.remove('border-red-500', 'bg-red-50'); }, 500); }
        function resetUI() { urlInput.value = ''; resultState.classList.add('hidden'); downloadBtn.classList.remove('hidden'); urlInput.focus(); }
    </script>
</body>
</html>
